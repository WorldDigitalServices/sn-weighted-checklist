<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Weighted Checklist</title>
  <style>
    :root {
      --bg: var(--sn-stylekit-background-color, #ffffff);
      --fg: var(--sn-stylekit-foreground-color, #1a1a1a);
      --border: var(--sn-stylekit-border-color, #e0e0e0);
      --contrast-bg: var(--sn-stylekit-contrast-background-color, #f5f5f5);
      --info: var(--sn-stylekit-info-color, #086dd6);
      --neutral: var(--sn-stylekit-neutral-color, #8e8e8e);
      --danger: var(--sn-stylekit-danger-color, #d64343);
    }
    /* Dark mode for standalone use */
    @media (prefers-color-scheme: dark) {
      :root:not(.light-mode) {
        --sn-stylekit-background-color: #1a1a1a;
        --sn-stylekit-foreground-color: #e8e8e8;
        --sn-stylekit-border-color: #404040;
        --sn-stylekit-contrast-background-color: #2a2a2a;
        --sn-stylekit-info-color: #5eb3f3;
        --sn-stylekit-neutral-color: #888888;
        --sn-stylekit-danger-color: #e57373;
      }
    }
    :root.dark-mode {
      --sn-stylekit-background-color: #1a1a1a;
      --sn-stylekit-foreground-color: #e8e8e8;
      --sn-stylekit-border-color: #404040;
      --sn-stylekit-contrast-background-color: #2a2a2a;
      --sn-stylekit-info-color: #5eb3f3;
      --sn-stylekit-neutral-color: #888888;
      --sn-stylekit-danger-color: #e57373;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { 
      min-height: 100%; 
      background: var(--bg);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 16px;
      color: var(--fg);
      line-height: 1.5;
      -webkit-overflow-scrolling: touch;
    }
    .container { padding: 16px; }
    .add-row { 
      display: flex; 
      gap: 8px; 
      padding-bottom: 12px; 
      border-bottom: 1px solid var(--border); 
      margin-bottom: 12px; 
    }
    .add-input { 
      flex: 1; 
      padding: 12px; 
      font-size: 16px; 
      border: 1px solid var(--border); 
      border-radius: 8px; 
      background: var(--bg); 
      color: var(--fg); 
      outline: none;
    }
    .add-input:focus { border-color: var(--info); }
    .add-btn { 
      width: 48px; 
      height: 48px; 
      border: none; 
      border-radius: 8px; 
      background: var(--info); 
      color: white; 
      font-size: 24px; 
      cursor: pointer;
    }
    .add-btn:disabled { opacity: 0.4; }
    .items { display: flex; flex-direction: column; gap: 8px; }
    .item { 
      display: flex; 
      align-items: center; 
      gap: 10px; 
      padding: 12px; 
      border: 1px solid; 
      border-left-width: 4px; 
      border-radius: 8px;
    }
    .item.done { 
      opacity: 0.5; 
      background: var(--contrast-bg) !important; 
      border-color: var(--border) !important; 
    }
    .check-btn, .weight-btn, .del-btn, .sub-btn { 
      width: 44px; 
      height: 44px; 
      min-width: 44px; 
      border: none; 
      border-radius: 6px; 
      background: transparent; 
      font-size: 18px; 
      cursor: pointer;
      color: inherit;
    }
    .sub-btn { font-size: 14px; width: 32px; min-width: 32px; height: 32px; }
    .weight-btn:disabled { opacity: 0.3; }
    .del-btn { color: var(--neutral); }
    .del-btn:hover { color: var(--danger); }
    .item-text { flex: 1; word-break: break-word; cursor: text; }
    .item.done .item-text { 
      text-decoration: line-through; 
      color: var(--neutral); 
    }
    .weight-box { display: flex; align-items: center; gap: 4px; }
    .weight-num { 
      min-width: 28px; 
      height: 28px; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      font-size: 14px; 
      font-weight: 600; 
      background: var(--contrast-bg); 
      border-radius: 4px;
    }
    .item.done .weight-box { display: none; }
    .item.done .sub-btn { display: none; }
    .divider { 
      display: flex; 
      align-items: center; 
      gap: 12px; 
      margin: 12px 0; 
      color: var(--neutral); 
      font-size: 13px; 
      text-transform: uppercase;
    }
    .divider::before, .divider::after { 
      content: ''; 
      flex: 1; 
      height: 1px; 
      background: var(--border); 
    }
    .empty { 
      text-align: center; 
      padding: 48px; 
      color: var(--neutral); 
    }
    .edit-input { 
      flex: 1; 
      padding: 8px; 
      font-size: 16px; 
      border: 1px solid var(--info); 
      border-radius: 4px; 
      background: var(--bg);
      color: var(--fg);
      outline: none;
    }
    .subtasks { 
      margin-left: 48px; 
      margin-top: 4px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .subtask {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      background: var(--contrast-bg);
      border-radius: 6px;
    }
    .subtask.done { opacity: 0.5; }
    .subtask.done .subtask-text { text-decoration: line-through; color: var(--neutral); }
    .subtask-text { flex: 1; font-size: 14px; cursor: text; }
    .subtask .check-btn { width: 32px; height: 32px; min-width: 32px; font-size: 14px; }
    .subtask .del-btn { width: 28px; height: 28px; min-width: 28px; font-size: 12px; }
    .add-subtask-row {
      display: flex;
      gap: 6px;
      margin-left: 48px;
      margin-top: 4px;
    }
    .add-subtask-input {
      flex: 1;
      padding: 6px 8px;
      font-size: 14px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--bg);
      color: var(--fg);
      outline: none;
    }
    .add-subtask-btn {
      padding: 6px 12px;
      font-size: 14px;
      border: none;
      border-radius: 6px;
      background: var(--info);
      color: white;
      cursor: pointer;
    }
    .progress {
      font-size: 13px;
      color: var(--neutral);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      flex-wrap: wrap;
    }
    .clear-btn {
      font-size: 13px;
      color: var(--neutral);
      background: none;
      border: none;
      cursor: pointer;
      text-decoration: underline;
      margin-left: 12px;
    }
    .clear-btn:hover { color: var(--danger); }
    .theme-toggle {
      margin-left: auto;
      font-size: 18px;
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      opacity: 0.6;
    }
    .theme-toggle:hover { opacity: 1; background: var(--contrast-bg); }
  </style>
</head>
<body>
  <div class="container" id="app"></div>

  <script>
    (function() {
      // Weight colors - will be adjusted for dark mode
      var COLORS_LIGHT = {
        1: { bg: '#e8f0fe', border: '#94a3b8', text: '#475569' },
        2: { bg: '#e0f2fe', border: '#38bdf8', text: '#0369a1' },
        3: { bg: '#fef3c7', border: '#fbbf24', text: '#92400e' },
        4: { bg: '#ffedd5', border: '#fb923c', text: '#c2410c' },
        5: { bg: '#fee2e2', border: '#f87171', text: '#b91c1c' }
      };
      var COLORS_DARK = {
        1: { bg: '#1e293b', border: '#64748b', text: '#94a3b8' },
        2: { bg: '#0c4a6e', border: '#0ea5e9', text: '#7dd3fc' },
        3: { bg: '#713f12', border: '#f59e0b', text: '#fcd34d' },
        4: { bg: '#7c2d12', border: '#f97316', text: '#fdba74' },
        5: { bg: '#7f1d1d', border: '#ef4444', text: '#fca5a5' }
      };
      
      function getColors() {
        return isDarkMode() ? COLORS_DARK : COLORS_LIGHT;
      }
      
      function isDarkMode() {
        if (document.documentElement.classList.contains('dark-mode')) return true;
        if (document.documentElement.classList.contains('light-mode')) return false;
        // Check if SN has set dark theme via CSS variables
        var bg = getComputedStyle(document.documentElement).getPropertyValue('--sn-stylekit-background-color').trim();
        if (bg && bg !== '#ffffff') {
          // Parse the color to check if it's dark
          var match = bg.match(/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/i);
          if (match) {
            var r = parseInt(match[1], 16);
            var g = parseInt(match[2], 16);
            var b = parseInt(match[3], 16);
            var luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
            return luminance < 0.5;
          }
        }
        return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      }

      var isStandalone = true; // Will be set to false if SN responds

      // State
      var items = [];
      var editingId = null;
      var editingSubId = null;
      var addingSubTo = null;
      var locked = false;

      // Standard Notes state
      var sessionKey = null;
      var lastNote = null;
      var sentMessages = [];
      var isMobile = false;

      // Generate UUID
      function genUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
          var r = Math.random() * 16 | 0;
          return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
        });
      }

      function genId() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
      }

      // Sort items: active by weight desc, then done
      function sortItems(arr) {
        var active = [];
        var done = [];
        for (var i = 0; i < arr.length; i++) {
          if (arr[i].done) done.push(arr[i]);
          else active.push(arr[i]);
        }
        active.sort(function(a, b) { return b.weight - a.weight; });
        return active.concat(done);
      }

      // Parse JSON data
      function parseData(text) {
        if (!text) return [];
        try {
          var d = JSON.parse(text);
          if (d && Array.isArray(d.items)) {
            // Ensure subtasks array exists
            for (var i = 0; i < d.items.length; i++) {
              if (!d.items[i].subtasks) d.items[i].subtasks = [];
            }
            return sortItems(d.items);
          }
          return [];
        } catch (e) { return []; }
      }

      // Post message to Standard Notes
      function postMessage(action, data, callback) {
        var msgId = genUUID();
        var msg = {
          action: action,
          data: data,
          messageId: msgId,
          sessionKey: sessionKey,
          api: 'component'
        };

        if (callback) {
          sentMessages.push({ messageId: msgId, callback: callback });
        }

        var toSend = isMobile ? JSON.stringify(msg) : msg;
        window.parent.postMessage(toSend, '*');
      }

      // Save to Standard Notes
      function saveToSN() {
        if (!lastNote || !sessionKey) return;

        var text = JSON.stringify({ version: 1, items: items });
        lastNote.content.text = text;
        lastNote.content.preview_plain = getPreview();

        var itemCopy = JSON.parse(JSON.stringify(lastNote));
        delete itemCopy.children;
        delete itemCopy.parent;

        postMessage('save-items', { items: [itemCopy] });
      }

      // Get preview text
      function getPreview() {
        var active = items.filter(function(i) { return !i.done; });
        if (active.length === 0) return 'No tasks';
        var first = active[0].text;
        if (first.length > 40) first = first.substring(0, 40) + '...';
        return active.length + ' tasks: ' + first;
      }

      // Save data
      function saveData() {
        try {
          localStorage.setItem('wds-weighted-checklist', JSON.stringify({ version: 1, items: items }));
        } catch (e) {}
        saveToSN();
      }

      // Handle incoming messages from Standard Notes
      function handleMessage(event) {
        var data = event.data;
        if (typeof data === 'string') {
          try { data = JSON.parse(data); } catch (e) { return; }
        }
        if (!data || typeof data !== 'object') return;

        // Component registered
        if (data.action === 'component-registered') {
          sessionKey = data.sessionKey;
          isStandalone = false;
          if (data.data) {
            if (data.data.environment === 'mobile') isMobile = true;
          }
          // Request the note
          postMessage('stream-context-item', {}, function(response) {
            if (response && response.item) {
              handleNote(response.item);
            }
          });
          // Handle themes
          if (data.data && data.data.activeThemeUrls) {
            activateThemes(data.data.activeThemeUrls);
          }
        }

        // Theme activation
        if (data.action === 'themes') {
          if (data.data && data.data.themes) {
            activateThemes(data.data.themes);
          }
        }

        // Response to our message
        if (data.original && data.original.messageId) {
          for (var i = 0; i < sentMessages.length; i++) {
            if (sentMessages[i].messageId === data.original.messageId) {
              if (sentMessages[i].callback) {
                sentMessages[i].callback(data.data);
              }
              sentMessages.splice(i, 1);
              break;
            }
          }
        }

        // Streamed note update
        if (data.action === 'stream-context-item' && data.data && data.data.item) {
          handleNote(data.data.item);
        }
      }

      // Handle note data
      function handleNote(note) {
        if (!note) return;
        
        // Don't reload if this is just a metadata update we triggered
        if (note.isMetadataUpdate) return;

        lastNote = note;
        
        if (note.content && note.content.text) {
          items = parseData(note.content.text);
        } else {
          items = [];
        }

        // Check locked
        if (note.content && note.content.appData && note.content.appData['org.standardnotes.sn']) {
          locked = !!note.content.appData['org.standardnotes.sn'].locked;
        } else {
          locked = false;
        }

        render();
      }

      // Activate themes
      function activateThemes(urls) {
        // Remove old themes
        var oldThemes = document.querySelectorAll('.sn-theme');
        for (var i = 0; i < oldThemes.length; i++) {
          oldThemes[i].parentNode.removeChild(oldThemes[i]);
        }

        // Add new themes
        for (var j = 0; j < urls.length; j++) {
          if (!urls[j]) continue;
          var link = document.createElement('link');
          link.className = 'sn-theme';
          link.rel = 'stylesheet';
          link.href = urls[j];
          document.head.appendChild(link);
        }

        // Re-render after a short delay to pick up new CSS variables
        setTimeout(function() { render(); }, 100);
      }

      // Escape HTML
      function escapeHtml(text) {
        var div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // Render UI
      function render() {
        var app = document.getElementById('app');
        var active = [];
        var done = [];
        var COLORS = getColors();
        
        for (var i = 0; i < items.length; i++) {
          if (items[i].done) done.push(items[i]);
          else active.push(items[i]);
        }

        var totalTasks = items.length;
        var doneTasks = done.length;

        var html = '';

        // Progress and controls row
        html += '<div class="progress">';
        if (totalTasks > 0) {
          html += '<span>' + doneTasks + '/' + totalTasks + ' completed</span>';
          if (doneTasks > 0) {
            html += '<button class="clear-btn" id="clearDone">Clear completed</button>';
          }
        } else if (isStandalone) {
          html += '<span>&nbsp;</span>'; // Spacer
        }
        // Theme toggle (only show in standalone mode)
        if (isStandalone) {
          html += '<button class="theme-toggle" id="themeToggle" title="Toggle dark mode">' + (isDarkMode() ? '‚òÄÔ∏è' : 'üåô') + '</button>';
        }
        html += '</div>';

        // Add row
        html += '<div class="add-row">';
        html += '<input type="text" class="add-input" id="newItem" placeholder="Add new item..."' + (locked ? ' disabled' : '') + '>';
        html += '<button class="add-btn" id="addBtn"' + (locked ? ' disabled' : '') + '>+</button>';
        html += '</div>';
        html += '<div class="items">';

        if (items.length === 0) {
          html += '<div class="empty">';
          html += '<p style="font-size:18px;font-weight:500;margin-bottom:4px;">No items yet</p>';
          html += '<p style="opacity:0.7;">Add your first task above</p>';
          html += '</div>';
        }

        // Active items
        for (var i = 0; i < active.length; i++) {
          html += renderItem(active[i], false, COLORS);
        }

        // Completed divider
        if (done.length > 0) {
          html += '<div class="divider">Completed</div>';
          for (var j = 0; j < done.length; j++) {
            html += renderItem(done[j], true, COLORS);
          }
        }

        html += '</div>';
        app.innerHTML = html;
        attachEvents();
      }

      // Render single item
      function renderItem(item, isDone, COLORS) {
        var c = COLORS[item.weight] || COLORS[3];
        var html = '';
        
        html += '<div class="item' + (isDone ? ' done' : '') + '" data-id="' + item.id + '" style="background:' + c.bg + ';border-color:' + c.border + ';color:' + c.text + ';">';
        html += '<button class="check-btn" data-action="toggle">' + (isDone ? '&#9745;' : '&#9744;') + '</button>';
        
        if (editingId === item.id) {
          html += '<input type="text" class="edit-input" id="editInput" value="' + escapeHtml(item.text) + '">';
        } else {
          html += '<span class="item-text" data-action="edit">' + escapeHtml(item.text) + '</span>';
        }
        
        if (!isDone) {
          html += '<button class="sub-btn" data-action="addsub" title="Add subtask">+sub</button>';
          html += '<div class="weight-box">';
          html += '<button class="weight-btn" data-action="down"' + (item.weight <= 1 || locked ? ' disabled' : '') + '>&#9660;</button>';
          html += '<span class="weight-num">' + item.weight + '</span>';
          html += '<button class="weight-btn" data-action="up"' + (item.weight >= 5 || locked ? ' disabled' : '') + '>&#9650;</button>';
          html += '</div>';
        }
        
        html += '<button class="del-btn" data-action="delete"' + (locked ? ' disabled' : '') + '>&#10005;</button>';
        html += '</div>';

        // Subtasks
        if (item.subtasks && item.subtasks.length > 0) {
          html += '<div class="subtasks">';
          for (var s = 0; s < item.subtasks.length; s++) {
            var sub = item.subtasks[s];
            html += '<div class="subtask' + (sub.done ? ' done' : '') + '" data-id="' + item.id + '" data-subid="' + sub.id + '">';
            html += '<button class="check-btn" data-action="togglesub">' + (sub.done ? '&#9745;' : '&#9744;') + '</button>';
            
            if (editingSubId === sub.id) {
              html += '<input type="text" class="edit-input" id="editSubInput" value="' + escapeHtml(sub.text) + '">';
            } else {
              html += '<span class="subtask-text" data-action="editsub">' + escapeHtml(sub.text) + '</span>';
            }
            
            html += '<button class="del-btn" data-action="deletesub"' + (locked ? ' disabled' : '') + '>&#10005;</button>';
            html += '</div>';
          }
          html += '</div>';
        }

        // Add subtask row
        if (addingSubTo === item.id) {
          html += '<div class="add-subtask-row">';
          html += '<input type="text" class="add-subtask-input" id="newSubInput" placeholder="Subtask...">';
          html += '<button class="add-subtask-btn" id="addSubBtn">Add</button>';
          html += '</div>';
        }

        return html;
      }

      // Attach event handlers
      function attachEvents() {
        var addBtn = document.getElementById('addBtn');
        var newInput = document.getElementById('newItem');
        var editInput = document.getElementById('editInput');
        var editSubInput = document.getElementById('editSubInput');
        var clearDone = document.getElementById('clearDone');
        var newSubInput = document.getElementById('newSubInput');
        var addSubBtn = document.getElementById('addSubBtn');

        if (addBtn) addBtn.onclick = function(e) { e.preventDefault(); addItem(); };
        if (newInput) newInput.onkeydown = function(e) { if (e.key === 'Enter') { e.preventDefault(); addItem(); } };
        
        if (editInput) {
          editInput.focus();
          editInput.select();
          editInput.onblur = function() { saveEdit(); };
          editInput.onkeydown = function(e) { if (e.key === 'Enter') { e.preventDefault(); saveEdit(); } };
        }

        if (editSubInput) {
          editSubInput.focus();
          editSubInput.select();
          editSubInput.onblur = function() { saveSubEdit(); };
          editSubInput.onkeydown = function(e) { if (e.key === 'Enter') { e.preventDefault(); saveSubEdit(); } };
        }

        if (clearDone) clearDone.onclick = function(e) { e.preventDefault(); clearCompleted(); };

        var themeToggle = document.getElementById('themeToggle');
        if (themeToggle) themeToggle.onclick = function(e) { e.preventDefault(); toggleTheme(); };

        if (newSubInput) {
          newSubInput.focus();
          newSubInput.onkeydown = function(e) { if (e.key === 'Enter') { e.preventDefault(); addSubtask(); } };
        }
        if (addSubBtn) addSubBtn.onclick = function(e) { e.preventDefault(); addSubtask(); };

        // Item events
        var itemEls = document.querySelectorAll('.item');
        for (var i = 0; i < itemEls.length; i++) {
          (function(el) {
            var id = el.getAttribute('data-id');
            el.onclick = function(e) {
              var action = e.target.getAttribute('data-action');
              if (!action) return;
              e.preventDefault();
              if (action === 'toggle') toggleItem(id);
              else if (action === 'edit') startEdit(id);
              else if (action === 'delete') deleteItem(id);
              else if (action === 'up') changeWeight(id, 1);
              else if (action === 'down') changeWeight(id, -1);
              else if (action === 'addsub') startAddSub(id);
            };
          })(itemEls[i]);
        }

        // Subtask events
        var subEls = document.querySelectorAll('.subtask');
        for (var j = 0; j < subEls.length; j++) {
          (function(el) {
            var id = el.getAttribute('data-id');
            var subId = el.getAttribute('data-subid');
            el.onclick = function(e) {
              var action = e.target.getAttribute('data-action');
              if (!action) return;
              e.preventDefault();
              if (action === 'togglesub') toggleSub(id, subId);
              else if (action === 'editsub') startSubEdit(id, subId);
              else if (action === 'deletesub') deleteSub(id, subId);
            };
          })(subEls[j]);
        }
      }

      // Actions
      function addItem() {
        var inp = document.getElementById('newItem');
        if (!inp) return;
        var text = inp.value.trim();
        if (!text || locked) return;
        
        items.push({
          id: genId(),
          text: text,
          weight: 3,
          done: false,
          subtasks: [],
          createdAt: new Date().toISOString()
        });
        items = sortItems(items);
        saveData();
        render();
      }

      function toggleItem(id) {
        if (locked) return;
        for (var i = 0; i < items.length; i++) {
          if (items[i].id === id) {
            items[i].done = !items[i].done;
            break;
          }
        }
        items = sortItems(items);
        saveData();
        render();
      }

      function changeWeight(id, delta) {
        if (locked) return;
        for (var i = 0; i < items.length; i++) {
          if (items[i].id === id) {
            var w = items[i].weight + delta;
            if (w >= 1 && w <= 5) items[i].weight = w;
            break;
          }
        }
        items = sortItems(items);
        saveData();
        render();
      }

      function deleteItem(id) {
        if (locked) return;
        items = items.filter(function(i) { return i.id !== id; });
        saveData();
        render();
      }

      function startEdit(id) {
        if (locked) return;
        editingId = id;
        addingSubTo = null;
        render();
      }

      function saveEdit() {
        var inp = document.getElementById('editInput');
        if (inp && inp.value.trim() && editingId) {
          for (var i = 0; i < items.length; i++) {
            if (items[i].id === editingId) {
              items[i].text = inp.value.trim();
              break;
            }
          }
          saveData();
        }
        editingId = null;
        render();
      }

      function clearCompleted() {
        if (locked) return;
        items = items.filter(function(i) { return !i.done; });
        saveData();
        render();
      }

      function toggleTheme() {
        var root = document.documentElement;
        if (root.classList.contains('dark-mode')) {
          root.classList.remove('dark-mode');
          root.classList.add('light-mode');
          try { localStorage.setItem('wds-checklist-theme', 'light'); } catch(e) {}
        } else {
          root.classList.remove('light-mode');
          root.classList.add('dark-mode');
          try { localStorage.setItem('wds-checklist-theme', 'dark'); } catch(e) {}
        }
        render();
      }

      // Subtask actions
      function startAddSub(id) {
        if (locked) return;
        addingSubTo = id;
        editingId = null;
        render();
      }

      function addSubtask() {
        if (locked || !addingSubTo) return;
        var inp = document.getElementById('newSubInput');
        if (!inp) return;
        var text = inp.value.trim();
        if (!text) return;

        for (var i = 0; i < items.length; i++) {
          if (items[i].id === addingSubTo) {
            if (!items[i].subtasks) items[i].subtasks = [];
            items[i].subtasks.push({
              id: genId(),
              text: text,
              done: false
            });
            break;
          }
        }
        addingSubTo = null;
        saveData();
        render();
      }

      function toggleSub(itemId, subId) {
        if (locked) return;
        for (var i = 0; i < items.length; i++) {
          if (items[i].id === itemId && items[i].subtasks) {
            for (var j = 0; j < items[i].subtasks.length; j++) {
              if (items[i].subtasks[j].id === subId) {
                items[i].subtasks[j].done = !items[i].subtasks[j].done;
                break;
              }
            }
            break;
          }
        }
        saveData();
        render();
      }

      function startSubEdit(itemId, subId) {
        if (locked) return;
        editingSubId = subId;
        editingId = null;
        addingSubTo = null;
        render();
      }

      function saveSubEdit() {
        var inp = document.getElementById('editSubInput');
        if (inp && inp.value.trim() && editingSubId) {
          outer:
          for (var i = 0; i < items.length; i++) {
            if (items[i].subtasks) {
              for (var j = 0; j < items[i].subtasks.length; j++) {
                if (items[i].subtasks[j].id === editingSubId) {
                  items[i].subtasks[j].text = inp.value.trim();
                  break outer;
                }
              }
            }
          }
          saveData();
        }
        editingSubId = null;
        render();
      }

      function deleteSub(itemId, subId) {
        if (locked) return;
        for (var i = 0; i < items.length; i++) {
          if (items[i].id === itemId && items[i].subtasks) {
            items[i].subtasks = items[i].subtasks.filter(function(s) { return s.id !== subId; });
            break;
          }
        }
        saveData();
        render();
      }

      // Initialize
      function init() {
        // Load saved theme preference
        try {
          var savedTheme = localStorage.getItem('wds-checklist-theme');
          if (savedTheme === 'dark') {
            document.documentElement.classList.add('dark-mode');
          } else if (savedTheme === 'light') {
            document.documentElement.classList.add('light-mode');
          }
        } catch (e) {}

        // Load from localStorage first
        try {
          var saved = localStorage.getItem('wds-weighted-checklist');
          if (saved) {
            items = parseData(saved);
          }
        } catch (e) {}

        // Render immediately
        render();

        // Listen for Standard Notes messages
        window.addEventListener('message', handleMessage);

        // Register with Standard Notes
        if (window.parent !== window) {
          // Initial message to trigger registration
          var initMsg = {
            action: 'component-initialized',
            messageId: genUUID(),
            api: 'component'
          };
          window.parent.postMessage(initMsg, '*');
        }
      }

      init();
    })();
  </script>
</body>
</html>
